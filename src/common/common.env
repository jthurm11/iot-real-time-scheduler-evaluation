#!/bin/bash
# Common environment variables and functions for bash scripts

# Define a wrapper function for configuration retrieval
function get_param {
    local section="${1}"
    local key=$"{2}"
    # Call the python script and capture its stdout
    local parser="/opt/project/common/read_config.py"
    if [ ! -f "$parser" ]; then
        parser="./common/read_config.py"
    fi
    /usr/bin/python3 "$parser" "$section" "$key"
}

# Execution and Variable Definition Section

# 1. Read Base Variables from config.ini
WIFI_IF=$(get_param "Network" "WIFI_IF")
CONN_NAME=$(get_param "Network" "CONN_NAME")
SIGNAL_NET_PREFIX=$(get_param "Network" "SIGNAL_NET_PREFIX")
ALPHA_IP_SUFFIX=$(get_param "Nodes" "ALPHA_IP_SUFFIX")
BETA_IP_SUFFIX=$(get_param "Nodes" "BETA_IP_SUFFIX")
SERVICE_USER=$(get_param "System" "SERVICE_USER")
INSTALL_DIR=$(get_param "Paths" "INSTALL_DIR")
GIT_DIR_BASE=$(get_param "Paths" "GIT_DIR_BASE")
GIT_REPO_NAME=$(get_param "Paths" "GIT_REPO_NAME")

# 2. Calculate Derived Variables
ALPHA_IP="${SIGNAL_NET_PREFIX}.${ALPHA_IP_SUFFIX}"
BETA_IP="${SIGNAL_NET_PREFIX}.${BETA_IP_SUFFIX}"
GIT_DIR="${HOME}/${GIT_DIR_BASE}"
GIT_ROOT="${GIT_DIR}/${GIT_REPO_NAME}"
SCRIPT_DIR="${GIT_ROOT}/src"

# 3. Determine Peer Variables
curr_name=$(nmcli general hostname)
case "$curr_name" in
    "alpha")
        TARGET_NODE="alpha"
        TARGET_IP="${ALPHA_IP}"
        NEIGHBOR_NODE="beta"
        NEIGHBOR_IP="${BETA_IP}"
        TARGET_NET_MASK="${TARGET_IP}/24"
        ;;
    "beta")
        TARGET_NODE="beta"
        TARGET_IP="${BETA_IP}"
        NEIGHBOR_NODE="alpha"
        NEIGHBOR_IP="${ALPHA_IP}"
        TARGET_NET_MASK="${TARGET_IP}/24"
        ;;
esac

# 4. Export Peer Variables
export WIFI_IF CONN_NAME ALPHA_IP BETA_IP SERVICE_USER INSTALL_DIR SCRIPT_DIR
export TARGET_NODE TARGET_IP NEIGHBOR_NODE NEIGHBOR_IP TARGET_NET_MASK