<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Project Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        /* Chart specific height */
        .chart-container { height: 350px; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans antialiased p-4 sm:p-8">
    
    <div class="max-w-7xl mx-auto space-y-8">
        <header class="text-center">
            <h1 class="text-4xl font-extrabold text-indigo-400 mb-2">IoT Project Dashboard</h1>
            <p class="text-lg text-gray-400">Real-Time Traffic Scheduling Experiment Interface</p>
        </header>

        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
            <p id="command-message" class="text-sm mt-4 italic text-center transition-opacity duration-300 opacity-0 h-4"></p>
            
            <div class="flex flex-col lg:flex-row lg:justify-between lg:items-end space-y-4 lg:space-y-0 lg:space-x-8">
                
                <div class="flex flex-col space-y-4 w-full lg:w-1/3">
                    <div class="flex items-center space-x-3">
                        <div id="status-dot" class="w-4 h-4 rounded-full bg-red-500 shadow-xl shadow-red-500/30 transition-colors duration-500"></div>
                        <span class="text-2xl font-semibold" id="experiment-status-text">STATUS: STOPPED</span>
                    </div>

                    <div class="space-y-2">
                        <label for="load-type-select" class="block text-sm font-medium text-gray-400">Experiment Scenario (Network Load)</label>
                        <select id="load-type-select"
                                class="w-full bg-gray-700 border border-gray-600 text-white text-md rounded-lg focus:ring-indigo-500 focus:border-indigo-500 p-2.5 shadow-inner">
                            <option value="none" selected>Baseline (No Background Load)</option>
                            <option value="iperf">Traffic Load (iPerf/UDP Flood)</option>
                            <option value="stress">CPU/Memory Load (Stress-ng)</option>
                        </select>
                        <p class="text-xs text-gray-500">Select the background activity for the fan node.</p>
                    </div>
                </div>

                <div class="flex space-x-3 w-full lg:w-auto justify-center lg:justify-end">
                    <button id="start-button" 
                            class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-full font-bold text-lg transition duration-200 shadow-md active:scale-95">
                        Start Experiment
                    </button>
                    <button id="stop-button" 
                            class="px-6 py-3 bg-red-600 hover:bg-red-700 rounded-full font-bold text-lg transition duration-200 shadow-md active:scale-95">
                        Stop Experiment
                    </button>
                </div>
            </div>

            <div class="mt-6 pt-4 border-t border-gray-700 grid grid-cols-1 md:grid-cols-3 gap-6">

                <div class="col-span-full mb-2">
                    <h3 class="text-lg font-bold text-indigo-400">Dynamic Controls</h3>
                </div>

                <div class="space-y-2 col-span-1">
                    <div class="flex justify-between items-center">
                        <label for="setpoint-slider" class="text-lg font-medium text-purple-300">Target Height (Setpoint)</label>
                        <span id="setpoint-value" class="text-xl font-bold text-purple-400">20.0 cm</span>
                    </div>
                    <input type="range" id="setpoint-slider" min="15" max="50" value="20.0" step="1.0" 
                           class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <p class="text-xs text-gray-400">Desired ball height in **centimeters from the sensor**. (Range: 15-50 cm)</p>
                </div>

                <div class="space-y-2 col-span-1">
                    <div class="flex justify-between items-center">
                        <label for="delay-slider" class="text-lg font-medium text-indigo-300">Network Delay (Latency)</label>
                        <span id="delay-value" class="text-xl font-bold text-indigo-400">0 ms</span>
                    </div>
                    <input type="range" id="delay-slider" min="0" max="500" value="0" step="10" 
                           class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <p class="text-xs text-gray-400">Simulated one-way delay added to the control packet (in ms).</p>
                </div>
                
                <div class="space-y-2 col-span-1">
                    <div class="flex justify-between items-center">
                        <label for="loss-slider" class="text-lg font-medium text-indigo-300">Packet Loss Rate</label>
                        <span id="loss-value" class="text-xl font-bold text-indigo-400">0.0 %</span>
                    </div>
                    <input type="range" id="loss-slider" min="0" max="100" value="0" step="1" 
                           class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <p class="text-xs text-gray-400">Probability of a control packet being dropped (0-100%).</p>
                </div>
            </div>

        </div>

        <section id="real-time-telemetry" class="bg-gray-800 p-6 rounded-lg shadow-xl border border-gray-700">
            <h2 class="text-2xl font-semibold text-indigo-300 mb-4">Real-Time Telemetry</h2>
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 text-center">
                <div class="p-3 bg-gray-700 rounded-md">
                    <p class="text-sm text-gray-400">Current Height</p>
                    <p id="stat-height" class="text-2xl font-bold text-sky-400">N/A</p>
                </div>
                <div class="p-3 bg-gray-700 rounded-md">
                    <p class="text-sm text-gray-400">Fan Output Cmd</p>
                    <p id="stat-fan-output" class="text-2xl font-bold text-sky-400">N/A</p>
                </div>
                <div class="p-3 bg-gray-700 rounded-md">
                    <p class="text-sm text-gray-400">Fan RPM Status</p>
                    <p id="stat-fan-rpm" class="text-2xl font-bold text-sky-400">N/A</p>
                </div>
                <div class="p-3 bg-gray-700 rounded-md">
                    <p class="text-sm text-gray-400">Congestion (D/L)</p>
                    <p id="stat-congestion" class="text-xl font-bold text-red-400">N/A</p>
                </div>
            </div>
        </section>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 chart-container">
                <h2 class="text-xl font-bold mb-4 text-indigo-300">Height (cm) &amp; Setpoint</h2>
                <canvas id="heightChart"></canvas>
            </div>

            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 chart-container">
                <h2 class="text-xl font-bold mb-4 text-indigo-300">Fan Output (%) &amp; RPM</h2>
                <canvas id="fanChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CHART_HISTORY_SIZE = 120; // Show the last 60 data points
        const UPDATE_INTERVAL_MS = 100; // Update the chart every 100ms
        const SERVER_URL = document.location.origin;

        // --- DOM ELEMENTS ---
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('experiment-status-text');
        const loadTypeSelect = document.getElementById('load-type-select'); 
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');
        const cmdMessage = document.getElementById('command-message');
        
        // Sliders
        const setpointSlider = document.getElementById('setpoint-slider');
        const setpointValueSpan = document.getElementById('setpoint-value');
        const delaySlider = document.getElementById('delay-slider');
        const delayValueSpan = document.getElementById('delay-value');
        const lossSlider = document.getElementById('loss-slider');
        const lossValueSpan = document.getElementById('loss-value');

        // Telemetry Display elements (NEW)
        const statHeight = document.getElementById('stat-height');
        const statFanOutput = document.getElementById('stat-fan-output');
        const statFanRPM = document.getElementById('stat-fan-rpm');
        const statCongestion = document.getElementById('stat-congestion');


        // --- DATA STORAGE ---
        const dataQueue = {
            t: [], 
            height: [],
            setpoint: [],
            fanOutput: [], 
            fanRPM: []
        };
        
        // --- SOCKET.IO SETUP ---
        const socket = io(SERVER_URL);

        socket.on('connect', () => {
            console.log('Connected to server via SocketIO');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            updateStatus('DISCONNECTED', 'gray');
        });
        
        // --- SOCKET.IO HANDLERS (New Unified Telemetry) ---
        
        socket.on('status_update', (status) => {
            // Update numeric status displays
            statHeight.textContent = `${status.current_height.toFixed(2)} cm`;
            statFanOutput.textContent = `${status.fan_output.toFixed(1)} %`;
            statFanRPM.textContent = `${status.fan_rpm} RPM`;
            statCongestion.textContent = `${status.delay.toFixed(0)}ms / ${status.loss_rate.toFixed(1)}%`;

            // Update data queue for charts
            // 1. Generate a unique time label for this new data point
            const now = new Date();
            // Use the timestamp from the status, or a local timestamp if the server doesn't provide one
            const timeLabel = status.last_update || now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
            
            dataQueue.t.push(timeLabel);
            dataQueue.height.push(status.current_height);
            dataQueue.setpoint.push(status.pid_setpoint);
            dataQueue.fanOutput.push(status.fan_output); // Fan Output Command from PID
            dataQueue.fanRPM.push(status.fan_rpm); // Fan RPM Status received by PID

            // Keep the slider UI synchronized with the confirmed setpoint/congestion status
            setpointSlider.value = status.pid_setpoint.toFixed(1);
            setpointValueSpan.textContent = `${status.pid_setpoint.toFixed(1)} cm`;
            
            // Note: Update congestion display from telemetry (which reflects the actual state)
            delaySlider.value = (status.delay).toFixed(0);
            delayValueSpan.textContent = `${(status.delay).toFixed(0)} ms`;
            lossSlider.value = status.loss_rate.toFixed(0);
            lossValueSpan.textContent = `${status.loss_rate.toFixed(1)} %`;
        });
        
        // 1. STATUS UPDATE HANDLER (Keep this logic)
        socket.on('experiment_status', (data) => {
            const status = data.status;
            console.log('Received Status:', status);
            if (status === 'running') {
                updateStatus('RUNNING', 'green');
            } else if (status === 'stopped') {
                updateStatus('STOPPED', 'red');
            } else if (status === 'error') {
                updateStatus('ERROR', 'amber');
            }
        });
        
        // 2. COMMAND ACKNOWLEDGEMENT (Keep this logic)
        socket.on('command_ack', (data) => {
            showMessage(data.message, data.success ? 'text-green-400' : 'text-red-400');
        });


        // --- SLIDER CONTROL LOGIC (Updated to use new event names and data format with Debounce) ---
        
        let setpointTimeout = null;
        let congestionTimeout = null;

        function sendCongestionUpdate() {
            const delay_ms = parseFloat(delaySlider.value);
            const loss_perc = parseFloat(lossSlider.value);
            
            if (socket.connected) {
               socket.emit('set_congestion', { 
                    delay_ms: delay_ms, 
                    loss_perc: loss_perc 
                });
                console.debug(`Sending Congestion: ${delay_ms}s, ${loss_perc}%`);
            }
        }
        
        function sendSetpointUpdate() {
            const setpoint = parseFloat(setpointSlider.value);
            
            if (socket.connected) {
                socket.emit('set_setpoint', { 
                    setpoint: setpoint
                });
                console.log(`Sending Setpoint: ${setpoint} cm`);
            }
        }

        // Setpoint Slider Listener
        setpointSlider.addEventListener('input', () => {
            const val = parseFloat(setpointSlider.value).toFixed(1);
            setpointValueSpan.textContent = `${val} cm`;
            
            clearTimeout(setpointTimeout);
            setpointTimeout = setTimeout(sendSetpointUpdate, 150);
        });

        // Delay Slider Listener
        delaySlider.addEventListener('input', () => {
            const val = delaySlider.value;
            delayValueSpan.textContent = `${val} ms`;

            clearTimeout(congestionTimeout);
            congestionTimeout = setTimeout(sendCongestionUpdate, 150);
        });

        // Loss Slider Listener
        lossSlider.addEventListener('input', () => {
            const val = parseFloat(lossSlider.value).toFixed(1);
            lossValueSpan.textContent = `${val} %`;

            clearTimeout(congestionTimeout);
            congestionTimeout = setTimeout(sendCongestionUpdate, 150);
        });


        // --- UI UTILITIES ---

        function updateStatus(text, color) {
            statusText.textContent = `STATUS: ${text}`;
            statusDot.className = `w-4 h-4 rounded-full bg-${color}-500 shadow-xl shadow-${color}-500/30 transition-colors duration-500`;
        }
        
        function showMessage(message, colorClass) {
            cmdMessage.textContent = message;
            cmdMessage.className = `text-sm mt-4 italic text-center transition-opacity duration-300 opacity-100 ${colorClass}`;
            setTimeout(() => {
                cmdMessage.className = cmdMessage.className.replace('opacity-100', 'opacity-0');
            }, 3000);
        }

        // --- BUTTON HANDLERS ---

        startButton.addEventListener('click', () => {
            const selectedLoadType = loadTypeSelect.value;
            socket.emit('start_experiment', { load_type: selectedLoadType });
            showMessage(`Sending START command for Scenario: ${selectedLoadType.toUpperCase()}...`, 'text-yellow-400');
        });

        stopButton.addEventListener('click', () => {
            socket.emit('stop_experiment');
            showMessage('Sending STOP command...', 'text-yellow-400');
        });

        // --- CHART INITIALIZATION & UPDATE LOOP ---
        
        // Redefining chart options for better clarity on axes labels
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            animation: false, // Turn off animation for better real-time performance
            plugins: {
                legend: { labels: { color: '#D1D5DB' } }
            },
            scales: {
                x: {
                    type: 'category',
                    title: { display: true, text: 'Time', color: '#9CA3AF' },
                    grid: { color: 'rgba(100, 100, 100, 0.2)' },
                    ticks: { color: '#9CA3AF', maxRotation: 45, minRotation: 45 }
                },
                y_height: { // Custom Y-axis for Height
                    type: 'linear',
                    position: 'left',
                    min: 0,
                    max: 70,
                    title: { display: true, text: 'Height (cm)', color: '#9CA3AF' },
                    grid: { color: 'rgba(100, 100, 100, 0.2)' },
                    ticks: { color: '#9CA3AF' }
                },
                y_percent: { // Custom Y-axis for Fan Output
                    type: 'linear',
                    position: 'left',
                    min: 0,
                    max: 100, 
                    title: { display: true, text: 'Output (%)', color: '#10B981' },
                    grid: { color: 'rgba(100, 100, 100, 0.2)' },
                    ticks: { color: '#10B981' }
                },
                y_rpm: { // Custom Y-axis for RPM
                    type: 'linear',
                    position: 'right',
                    min: 0,
                    max: 5500, // Adjusted max RPM for a more reasonable mock value
                    title: { display: true, text: 'Fan RPM', color: '#F59E0B' },
                    grid: { drawOnChartArea: false }, 
                    ticks: { color: '#F59E0B' }
                }
            }
        };

        const heightChartCtx = document.getElementById('heightChart').getContext('2d');
        const heightChart = new Chart(heightChartCtx, {
            type: 'line',
            data: {
                labels: dataQueue.t,
                datasets: [
                    {
                        label: 'Measured Height (cm)',
                        data: dataQueue.height,
                        borderColor: '#3B82F6', 
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.2,
                        fill: false,
                        pointRadius: 0,
                        yAxisID: 'y_height'
                    },
                    {
                        label: 'Setpoint (cm)',
                        data: dataQueue.setpoint,
                        borderColor: '#EF4444', 
                        borderDash: [5, 5],
                        tension: 0.2,
                        fill: false,
                        pointRadius: 0,
                        yAxisID: 'y_height'
                    }
                ]
            },
            options: {
                ...chartOptions,
                scales: {
                    x: chartOptions.scales.x,
                    y_height: chartOptions.scales.y_height
                }
            }
        });

        const fanChartCtx = document.getElementById('fanChart').getContext('2d');
        const fanChart = new Chart(fanChartCtx, {
            type: 'line',
            data: {
                labels: dataQueue.t,
                datasets: [
                    {
                        label: 'Fan Output Cmd (%)',
                        data: dataQueue.fanOutput,
                        borderColor: '#10B981', 
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.2,
                        fill: false,
                        yAxisID: 'y_percent',
                        pointRadius: 0
                    },
                    {
                        label: 'Fan RPM Status',
                        data: dataQueue.fanRPM,
                        borderColor: '#F59E0B', 
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.2,
                        fill: false,
                        yAxisID: 'y_rpm',
                        pointRadius: 0
                    }
                ]
            },
            options: {
                ...chartOptions,
                scales: {
                    x: chartOptions.scales.x,
                    y_percent: chartOptions.scales.y_percent,
                    y_rpm: chartOptions.scales.y_rpm
                }
            }
        });

        // --- REAL-TIME CHART UPDATE LOOP ---

        function updateCharts() {
            // Keep arrays constrained to history size
            while (dataQueue.t.length > CHART_HISTORY_SIZE) {
                for (const key in dataQueue) {
                    if (dataQueue.hasOwnProperty(key)) {
                        dataQueue[key].shift();
                    }
                }
            }

            // Update Chart.js data
            heightChart.data.labels = dataQueue.t;
            heightChart.data.datasets[0].data = dataQueue.height;
            heightChart.data.datasets[1].data = dataQueue.setpoint;

            fanChart.data.labels = dataQueue.t;
            fanChart.data.datasets[0].data = dataQueue.fanOutput;
            fanChart.data.datasets[1].data = dataQueue.fanRPM;

            // Animate and draw
            heightChart.update('none'); 
            fanChart.update('none');
        }

        // Set up the recurring timer to update the charts
        setInterval(updateCharts, UPDATE_INTERVAL_MS);

        // Initialize status on load
        updateStatus('STOPPED', 'red');
        
        // Initialize setpoint and congestion values on load
        const initialSetpoint = parseFloat(setpointSlider.value).toFixed(1);
        setpointValueSpan.textContent = `${initialSetpoint} cm`;
        
        const initialDelay = delaySlider.value;
        delayValueSpan.textContent = `${initialDelay} ms`;
        
        const initialLoss = parseFloat(lossSlider.value).toFixed(1);
        lossValueSpan.textContent = `${initialLoss} %`;

    </script>
</body>
</html>