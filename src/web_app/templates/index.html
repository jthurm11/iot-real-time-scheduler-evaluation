<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IoT Project Dashboard</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom scrollbar for better look */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #3b82f6; border-radius: 3px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        /* Chart specific height */
        .chart-container { height: 350px; }
    </style>
    <!-- Chart.js for graphing -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <!-- Socket.IO Client -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
</head>
<body class="bg-gray-900 text-white font-sans antialiased p-4 sm:p-8">
    
    <div class="max-w-7xl mx-auto space-y-8">
        <!-- Header -->
        <header class="text-center">
            <h1 class="text-4xl font-extrabold text-indigo-400 mb-2">IoT Project Dashboard</h1>
            <p class="text-lg text-gray-400">Real-Time Traffic Scheduling Experiment Interface</p>
        </header>

        <!-- Status and Controls -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700">
            
            <div class="flex flex-col lg:flex-row lg:justify-between lg:items-end space-y-4 lg:space-y-0 lg:space-x-8">
                
                <!-- Status Indicator & Load Type Dropdown -->
                <div class="flex flex-col space-y-4 w-full lg:w-1/3">
                    <!-- Status -->
                    <div class="flex items-center space-x-3">
                        <div id="status-dot" class="w-4 h-4 rounded-full bg-red-500 shadow-xl shadow-red-500/30 transition-colors duration-500"></div>
                        <span class="text-2xl font-semibold" id="experiment-status-text">STATUS: STOPPED</span>
                    </div>

                    <!-- Experiment Scenario Dropdown -->
                    <div class="space-y-2">
                        <label for="load-type-select" class="block text-sm font-medium text-gray-400">Experiment Scenario (Network Load)</label>
                        <select id="load-type-select"
                                class="w-full bg-gray-700 border border-gray-600 text-white text-md rounded-lg focus:ring-indigo-500 focus:border-indigo-500 p-2.5 shadow-inner">
                            <option value="none" selected>Baseline (No Background Load)</option>
                            <option value="iperf">Traffic Load (iPerf/UDP Flood)</option>
                            <option value="stress">CPU/Memory Load (Stress-ng)</option>
                        </select>
                        <p class="text-xs text-gray-500">Select the background activity for the fan node.</p>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div class="flex space-x-3 w-full lg:w-auto justify-center lg:justify-end">
                    <button id="start-button" 
                            class="px-6 py-3 bg-green-600 hover:bg-green-700 rounded-full font-bold text-lg transition duration-200 shadow-md shadow-green-600/50 active:scale-95">
                        Start Experiment
                    </button>
                    <button id="stop-button" 
                            class="px-6 py-3 bg-red-600 hover:bg-red-700 rounded-full font-bold text-lg transition duration-200 shadow-md shadow-red-600/50 active:scale-95">
                        Stop Experiment
                    </button>
                </div>
            </div>
            
            <!-- Dynamic Controls (Setpoint & Congestion Sliders) -->
            <div class="mt-6 pt-4 border-t border-gray-700 grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <div class="col-span-full mb-2">
                    <h3 class="text-lg font-bold text-indigo-400">Dynamic Controls</h3>
                </div>
                
                <!-- Setpoint Slider (NEW) -->
                <div class="space-y-2 col-span-1">
                    <div class="flex justify-between items-center">
                        <label for="setpoint-slider" class="text-lg font-medium text-purple-300">Target Height (Setpoint)</label>
                        <span id="setpoint-value" class="text-xl font-bold text-purple-400">20.0 cm</span>
                    </div>
                    <!-- Range: 15cm (close to fan) to 50cm (far from fan) -->
                    <input type="range" id="setpoint-slider" min="15" max="50" value="20.0" step="1.0" 
                           class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <p class="text-xs text-gray-400">Desired ball height in **centimeters from the sensor**. (Range: 15-50 cm)</p>
                </div>

                <!-- Delay Slider -->
                <div class="space-y-2 col-span-1">
                    <div class="flex justify-between items-center">
                        <label for="delay-slider" class="text-lg font-medium text-indigo-300">Network Delay (Latency)</label>
                        <span id="delay-value" class="text-xl font-bold text-indigo-400">0 ms</span>
                    </div>
                    <input type="range" id="delay-slider" min="0" max="100" value="0" step="5" 
                           class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <p class="text-xs text-gray-400">Simulated one-way delay added to the control packet.</p>
                </div>
                
                <!-- Loss Slider -->
                <div class="space-y-2 col-span-1">
                    <div class="flex justify-between items-center">
                        <label for="loss-slider" class="text-lg font-medium text-indigo-300">Packet Loss Rate</label>
                        <span id="loss-value" class="text-xl font-bold text-indigo-400">0.0 %</span>
                    </div>
                    <input type="range" id="loss-slider" min="0" max="50" value="0" step="0.5" 
                           class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    <p class="text-xs text-gray-400">Probability of a control packet being dropped.</p>
                </div>
            </div>

            <!-- Command Acknowledgment Message Box -->
            <p id="command-message" class="text-sm mt-4 italic text-center transition-opacity duration-300 opacity-0 h-4"></p>
        </div>

        <!-- Real-Time Graphs Container -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">

            <!-- Height and Setpoint Chart -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 chart-container">
                <h2 class="text-xl font-bold mb-4 text-indigo-300">Height (cm) &amp; Setpoint</h2>
                <canvas id="heightChart"></canvas>
            </div>

            <!-- Fan and RPM Chart -->
            <div class="bg-gray-800 p-6 rounded-xl shadow-lg border border-gray-700 chart-container">
                <h2 class="text-xl font-bold mb-4 text-indigo-300">Fan Output (%) &amp; RPM</h2>
                <canvas id="fanChart"></canvas>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const CHART_HISTORY_SIZE = 60; // Show the last 60 data points
        const UPDATE_INTERVAL_MS = 100; // Update the chart every 100ms
        const SERVER_URL = document.location.origin;

        // --- DOM ELEMENTS ---
        const statusDot = document.getElementById('status-dot');
        const statusText = document.getElementById('experiment-status-text');
        const loadTypeSelect = document.getElementById('load-type-select'); 
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');
        const cmdMessage = document.getElementById('command-message');
        
        // Sliders
        const setpointSlider = document.getElementById('setpoint-slider');
        const setpointValueSpan = document.getElementById('setpoint-value');
        const delaySlider = document.getElementById('delay-slider');
        const delayValueSpan = document.getElementById('delay-value');
        const lossSlider = document.getElementById('loss-slider');
        const lossValueSpan = document.getElementById('loss-value');


        // --- DATA STORAGE ---
        const dataQueue = {
            t: [], 
            height: [],
            setpoint: [],
            fanOutput: [], 
            fanRPM: []
        };
        
        // --- SOCKET.IO SETUP ---
        const socket = io(SERVER_URL);

        socket.on('connect', () => {
            console.log('Connected to server via SocketIO');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            updateStatus('DISCONNECTED', 'gray');
        });
        
        // --- SLIDER CONTROL LOGIC ---

        function sendCongestionUpdate() {
            const delay_ms = parseInt(delaySlider.value, 10);
            const loss_rate_perc = parseFloat(lossSlider.value);
            
            if (socket.connected) {
                socket.emit('update_congestion', { 
                    delay_ms: delay_ms, 
                    loss_rate_perc: loss_rate_perc 
                });
                console.debug(`Sending Congestion: ${delay_ms}ms, ${loss_rate_perc}%`);
            }
        }
        
        function sendSetpointUpdate() {
            const setpoint_cm = parseFloat(setpointSlider.value);
            
            if (socket.connected) {
                socket.emit('update_setpoint', { 
                    setpoint_cm: setpoint_cm
                });
                console.log(`Sending Setpoint: ${setpoint_cm} cm`);
            }
        }

        // Setpoint Slider Listener (NEW)
        setpointSlider.addEventListener('input', () => {
            const val = parseFloat(setpointSlider.value).toFixed(1);
            setpointValueSpan.textContent = `${val} cm`;
            sendSetpointUpdate();
        });

        // Delay Slider Listener
        delaySlider.addEventListener('input', () => {
            const val = delaySlider.value;
            delayValueSpan.textContent = `${val} ms`;
            sendCongestionUpdate();
        });

        // Loss Slider Listener
        lossSlider.addEventListener('input', () => {
            const val = parseFloat(lossSlider.value).toFixed(1);
            lossValueSpan.textContent = `${val} %`;
            sendCongestionUpdate();
        });


        // --- UTILITY: Data Queuing ---
        function queueData(source, data) {
            // 1. Generate a unique time label for this new data point (with milliseconds)
            const now = new Date();
            const timeLabel = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit' }) + '.' + String(now.getMilliseconds()).padStart(3, '0');
            dataQueue.t.push(timeLabel);

            // 2. Queue data, using NaN for data points not present in this packet type
            let h = NaN, sp = NaN, fO = NaN, fR = NaN;
            
            if (source === 'sensor') {
                h = data.height;
                sp = data.setpoint;
                fO = data.output; // PID Output is the commanded duty cycle
            } 
            
            else if (source === 'fan') {
                fR = data.rpm;
                fO = data.duty; // Measured duty cycle (telemetry)
            }
            
            // Push all five values, ensuring NaN is used for gaps
            dataQueue.height.push(h);
            dataQueue.setpoint.push(sp);
            dataQueue.fanOutput.push(fO);
            dataQueue.fanRPM.push(fR);
        }
        
        // --- SOCKET.IO HANDLERS (Data Reception) ---
        
        // 1. STATUS UPDATE HANDLER
        socket.on('experiment_status', (data) => {
            const status = data.status;
            console.log('Received Status:', status);
            if (status === 'running') {
                updateStatus('RUNNING', 'green');
            } else if (status === 'stopped') {
                updateStatus('STOPPED', 'red');
            } else if (status === 'error') { // FIX: Explicitly handle ERROR status
                updateStatus('ERROR', 'amber');
            }
        });
        
        // 2. FAN DATA HANDLER (RPM, Duty Cycle)
        socket.on('fan', (data) => {
            if (data.rpm !== undefined && data.duty !== undefined) {
                queueData('fan', data);
            }
        });

        // 3. SENSOR/PID DATA HANDLER (Height, Setpoint, PID Output)
        socket.on('sensor', (data) => {
            if (data.height !== undefined && data.setpoint !== undefined && data.output !== undefined) {
                queueData('sensor', data);
            }
        });

        // 4. COMMAND ACKNOWLEDGEMENT
        socket.on('command_ack', (data) => {
            showMessage(data.message, data.success ? 'text-green-400' : 'text-red-400');
        });

        // --- UI UTILITIES ---

        function updateStatus(text, color) {
            // color should be one of Tailwind's colors (e.g., 'red', 'green', 'amber', 'gray')
            statusText.textContent = `STATUS: ${text}`;
            statusDot.className = `w-4 h-4 rounded-full bg-${color}-500 shadow-xl shadow-${color}-500/30 transition-colors duration-500`;
        }
        
        function showMessage(message, colorClass) {
            cmdMessage.textContent = message;
            cmdMessage.className = `text-sm mt-4 italic text-center transition-opacity duration-300 opacity-100 ${colorClass}`;
            setTimeout(() => {
                cmdMessage.className = cmdMessage.className.replace('opacity-100', 'opacity-0');
            }, 3000);
        }

        // --- BUTTON HANDLERS ---

        startButton.addEventListener('click', () => {
            const selectedLoadType = loadTypeSelect.value;
            
            // Send the selected load type to the master controller
            socket.emit('start_experiment', { load_type: selectedLoadType });
            
            showMessage(`Sending START command for Scenario: ${selectedLoadType.toUpperCase()}...`, 'text-yellow-400');
        });

        stopButton.addEventListener('click', () => {
            socket.emit('stop_experiment');
            showMessage('Sending STOP command...', 'text-yellow-400');
        });

        // --- CHART INITIALIZATION (Unchanged) ---
        
        const chartOptions = {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                x: {
                    type: 'category',
                    title: { display: true, text: 'Time (HH:MM:SS.ms)', color: '#9CA3AF' },
                    grid: { color: 'rgba(100, 100, 100, 0.2)' },
                    ticks: { color: '#9CA3AF', maxRotation: 45, minRotation: 45 }
                }
            },
            plugins: {
                legend: { labels: { color: '#D1D5DB' } }
            }
        };

        const heightChartCtx = document.getElementById('heightChart').getContext('2d');
        const heightChart = new Chart(heightChartCtx, {
            type: 'line',
            data: {
                labels: dataQueue.t,
                datasets: [
                    {
                        label: 'Measured Height (cm)',
                        data: dataQueue.height,
                        borderColor: '#3B82F6', 
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.2,
                        fill: false,
                        pointRadius: 0
                    },
                    {
                        label: 'Setpoint (cm)',
                        data: dataQueue.setpoint,
                        borderColor: '#EF4444', 
                        borderDash: [5, 5],
                        tension: 0.2,
                        fill: false,
                        pointRadius: 0
                    }
                ]
            },
            options: chartOptions
        });

        const fanChartCtx = document.getElementById('fanChart').getContext('2d');
        const fanChart = new Chart(fanChartCtx, {
            type: 'line',
            data: {
                labels: dataQueue.t,
                datasets: [
                    {
                        label: 'Fan Output (%)',
                        data: dataQueue.fanOutput,
                        borderColor: '#10B981', 
                        backgroundColor: 'rgba(16, 185, 129, 0.1)',
                        tension: 0.2,
                        fill: false,
                        yAxisID: 'y_percent',
                        pointRadius: 0
                    },
                    {
                        label: 'Fan RPM',
                        data: dataQueue.fanRPM,
                        borderColor: '#F59E0B', 
                        backgroundColor: 'rgba(245, 158, 11, 0.1)',
                        tension: 0.2,
                        fill: false,
                        yAxisID: 'y_rpm',
                        pointRadius: 0
                    }
                ]
            },
            options: {
                ...chartOptions,
                scales: {
                    ...chartOptions.scales,
                    y_rpm: {
                        position: 'right',
                        min: 0,
                        max: 6000, 
                        title: { display: true, text: 'RPM', color: '#F59E0B' },
                        grid: { drawOnChartArea: false }, 
                        ticks: { color: '#F59E0B' }
                    },
                    y_percent: {
                        position: 'left',
                        min: 0,
                        max: 100, 
                        title: { display: true, text: 'Output (%)', color: '#9CA3AF' },
                        grid: { color: 'rgba(100, 100, 100, 0.2)' },
                        ticks: { color: '#9CA3AF' }
                    },
                    x: chartOptions.scales.x 
                }
            }
        });

        // --- REAL-TIME CHART UPDATE LOOP ---

        function updateCharts() {
            // Keep arrays constrained to history size
            while (dataQueue.t.length > CHART_HISTORY_SIZE) {
                for (const key in dataQueue) {
                    if (dataQueue.hasOwnProperty(key)) {
                        dataQueue[key].shift();
                    }
                }
            }

            // Update Chart.js data
            heightChart.data.labels = dataQueue.t;
            heightChart.data.datasets[0].data = dataQueue.height;
            heightChart.data.datasets[1].data = dataQueue.setpoint;

            fanChart.data.labels = dataQueue.t;
            fanChart.data.datasets[0].data = dataQueue.fanOutput;
            fanChart.data.datasets[1].data = dataQueue.fanRPM;

            // Animate and draw
            heightChart.update('none'); 
            fanChart.update('none');
        }

        // Set up the recurring timer to update the charts
        setInterval(updateCharts, UPDATE_INTERVAL_MS);

        // Initialize status on load
        updateStatus('STOPPED', 'red');
        
        // Initialize setpoint value on load
        const initialSetpoint = parseFloat(setpointSlider.value).toFixed(1);
        setpointValueSpan.textContent = `${initialSetpoint} cm`;

    </script>
</body>
</html>